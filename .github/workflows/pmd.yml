name: PMD Apex Scan + Review Comments

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  schedule:
    - cron: '23 6 * * 0'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  pmd-apex-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: temurin

      - name: üîΩ Download PMD 7.14.0 (for PR comments)
        run: |
          curl -L -o pmd7.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.14.0/pmd-dist-7.14.0-bin.zip
          unzip -q pmd7.zip
          mv pmd-bin-7.14.0 pmd7

      - name: üê∂ Run PMD 7.14.0 with Reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - name: üêæ PR Review Comments
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./pmd7/bin/pmd check \
            --no-cache \
            --force-language=apex \
            --dir Interns-HUB/force-app/main/default/classes \
            -R category/apex/bestpractices.xml \
            -f text \
            | reviewdog -efm="%f:%l:\ %m" \
                        -name="PMD Apex" \
                        -reporter=github-pr-review \
                        -fail-level=warning

      - name: üîΩ Download PMD 6.55.0 (for SARIF)
        run: |
          curl -L -o pmd6.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip -q pmd6.zip
          mv pmd-bin-6.55.0 pmd6

      - name: üõ° Generate SARIF using PMD 6.55.0
        run: |
          JAVA_OPTS="-Xmx2G" ./pmd6/bin/run.sh pmd \
            -d Interns-HUB/force-app/main/default/classes \
            -f sarif \
            -R category/apex/bestpractices.xml \
            -r pmd-report.sarif

      - name: üßæ Upload SARIF Report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif
          category: pmd-apex

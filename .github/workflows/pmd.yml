name: PMD Apex Code Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '23 6 * * 0'  # Every Sunday at 6:23 AM UTC

permissions:
  contents: read
  pull-requests: write

jobs:
  pmd-apex-scan:
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Download and run PMD 7.14.0 on Apex files
        run: |
          echo "‚¨áÔ∏è Downloading PMD..."
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.14.0/pmd-dist-7.14.0-bin.zip
          unzip -q pmd.zip
          mv pmd-bin-7.14.0 pmd

          echo "üìÑ Running PMD on Apex files inside Interns-HUB/force-app/main/default/classes..."

          JAVA_OPTS="-Xmx2G" ./pmd/bin/pmd check \
            --no-cache --no-progress --force-language=apex \
            -d Interns-HUB/force-app/main/default/classes \
            -f sarif \
            -R category/apex/bestpractices.xml \
            -r pmd-report.sarif

      - name: Fail if PMD found violations
        run: |
          if grep -q '"ruleId":' pmd-report.sarif; then
            echo "‚ùå PMD violations found. Failing build."
            exit 1
          else
            echo "‚úÖ No PMD violations found."
          fi

      - name: Upload SARIF report to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif
          category: apex-pmd

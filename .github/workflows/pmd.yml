name: PMD Apex Code Analysis with PR Comments

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  schedule:
    - cron: '23 6 * * 0'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  pmd-apex-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: temurin

      - name: Download PMD
        run: |
          curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.14.0/pmd-dist-7.14.0-bin.zip
          unzip -q pmd.zip
          mv pmd-bin-7.14.0 pmd

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - name: Run PMD and post PR review comments
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üê∂ Running PMD with Reviewdog..."

          ./pmd/bin/pmd check \
            --no-cache \
            --no-progress \
            --force-language=apex \
            --dir Interns-HUB/force-app/main/default/classes \
            -R category/apex/bestpractices.xml \
            -f text \
            --debug \
          | reviewdog -efm="%f:%l:\ %m" \
                      -name="PMD Apex" \
                      -reporter=github-pr-review \
                      -filter-mode=added \
                      -fail-level=warning

      - name: Generate SARIF Report for Security Tab
        run: |
          JAVA_OPTS="-Xmx2G" ./pmd/bin/pmd check \
            --no-cache \
            --no-progress \
            --force-language=apex \
            --dir Interns-HUB/force-app/main/default/classes \
            -R category/apex/bestpractices.xml \
            -f sarif -r pmd-report.sarif \
            --debug \
            --no-fail-on-violation

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif
          category: pmd-apex
